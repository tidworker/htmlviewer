<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>葉阿姨語音點餐系統</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f7f7f7;
            color: #333;
            margin: 0;
            padding: 0;
        }
        header {
            background-color: #4a4a4a;
            color: white;
            padding: 10px 0;
            text-align: center;
        }
        main {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }
        h1, h2 {
            margin: 0 0 20px;
            font-weight: normal;
        }
        label {
            display: block;
            margin-bottom: 10px;
            font-size: 18px;
        }
        #inputTextArea, #outputTextArea {
            width: 96%;
            height: 80px;
            margin-bottom: 20px;
            border-radius: 5px;
            border: 1px solid #ccc;
            padding: 10px;
            font-size: 14px;
            resize: none;
            background-color: #f9f9f9;
        }
        #clearBtn, #voiceBtn, #completeOrderBtn {
            font-size: 14px;
            padding: 10px 15px;
            background-color: #6c757d;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 5px;
        }
        #clearBtn {
            background-color: #adb5bd;
        }
        #voiceBtn.recording {
            background-color: #343a40; /* 按鈕激活時的顏色 */
        }
        #completeOrderBtn {
            background-color: #6c757d;
            margin-top: 10px;
        }
        #orderTable {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #e9ecef;
        }
        .quantityBtn {
            cursor: pointer;
            font-size: 18px;
            padding: 5px 10px;
            background-color: #6c757d;
            color: #fff;
            border: none;
            border-radius: 5px;
            margin-right: 5px;
        }
        .deleteBtn {
            cursor: pointer;
            font-size: 18px;
            padding: 5px 10px;
            background-color: #adb5bd;
            color: #fff;
            border: none;
            border-radius: 5px;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <header>
        <h1>葉阿姨語音點餐系統</h1>
    </header>
    <main>
        <textarea id="inputTextArea" placeholder="點擊後開啟語音輸入..." oninput="analyzeText()"></textarea>
        <button id="voiceBtn" onclick="startVoiceInput()">開始語音輸入</button>
        <button id="clearBtn" onclick="clearText()">清除點餐</button>

        <table id="orderTable">
            <thead>
                <tr>
                    <th>餐點名稱</th>
                    <th>單價</th>
                    <th>數量</th>
                    <th>總價</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="orderTableBody">
            </tbody>
        </table>
        <div>總金額：<span id="totalPrice">0</span>元</div>
        <button id="completeOrderBtn" onclick="completeOrder()">完成訂單</button>
    </main>

    <script>
    var itemPrices = {
        "芝麻蔥油餅": 20,
        "蔥油餅加蛋": 30,
        // 其餘菜單項目...
    };

    var homophones = {
        "麵": ["面", "念", "唸"],
        "線": ["鮮"],
        // 其餘同音字...
    };

    function simplifyHomophonesData(homophones) {
        var simplifiedHomophones = {};
        for (var key in homophones) {
            if (homophones.hasOwnProperty(key)) {
                var values = homophones[key];
                if (values.length > 1) {
                    simplifiedHomophones[key] = [values[0], values[values.length - 1]];
                } else {
                    simplifiedHomophones[key] = values;
                }
            }
        }
        return simplifiedHomophones;
    }

    function analyzeText() {
        var inputText = document.getElementById('inputTextArea').value;
        var matchedInfo = [];
        var totalAmount = 0;

        var simplifiedHomophones = simplifyHomophonesData(homophones);
        for (var homophone in simplifiedHomophones) {
            var homophoneArray = simplifiedHomophones[homophone];
            for (var i = 0; i < homophoneArray.length; i++) {
                var pattern = new RegExp(homophoneArray[i], 'gi');
                inputText = inputText.replace(pattern, homophone);
            }
        }

        for (var item in itemPrices) {
            var pattern = new RegExp(item + "\\s*(\\d+)份", 'gi');
            inputText = inputText.replace(pattern, function(match, quantity) {
                quantity = parseInt(quantity);
                var totalPrice = quantity * itemPrices[item];
                addToMatchedInfo(matchedInfo, item, quantity, totalPrice);
                totalAmount += totalPrice;
                return "";
            });
        }

        updateOrderTable(matchedInfo, totalAmount);
    }

    function addToMatchedInfo(matchedInfo, item, quantity, totalPrice) {
        var existingItem = matchedInfo.find(element => element.name === item);
        if (existingItem) {
            existingItem.quantity += quantity;
            existingItem.totalPrice += totalPrice;
        } else {
            matchedInfo.push({
                name: item,
                quantity: quantity,
                price: itemPrices[item],
                totalPrice: totalPrice
            });
        }
    }

    function updateOrderTable(matchedInfo, totalAmount) {
        var tableBody = document.getElementById('orderTableBody');
        tableBody.innerHTML = "";
        matchedInfo.forEach(item => {
            var row = tableBody.insertRow();
            row.insertCell(0).textContent = item.name;
            row.insertCell(1).textContent = item.price;
            row.insertCell(2).textContent = item.quantity;
            row.insertCell(3).textContent = item.totalPrice;
            var deleteBtn = document.createElement("button");
            deleteBtn.textContent = "刪除";
            deleteBtn.className = "deleteBtn";
            deleteBtn.onclick = function() {
                matchedInfo.splice(matchedInfo.indexOf(item), 1);
                row.remove();
                updateTotalPrice(matchedInfo);
            };
            row.insertCell(4).appendChild(deleteBtn);
        });
        updateTotalPrice(matchedInfo);
    }

    function updateTotalPrice(matchedInfo) {
        var totalPrice = matchedInfo.reduce((acc, item) => acc + item.totalPrice, 0);
        document.getElementById('totalPrice').textContent = totalPrice;
    }

    function startVoiceInput() {
        var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert("您的瀏覽器不支持語音識別功能，請使用支持此功能的瀏覽器。");
            return;
        }

        const recognition = new SpeechRecognition();
        recognition.lang = 'zh-TW'; // 設定語音識別的語言為中文(台灣)
        const output = document.getElementById('inputTextArea');
        let isRecording = false;

        recognition.onstart = function() {
            isRecording = true;
            document.getElementById('voiceBtn').classList.add('recording');
            document.getElementById('voiceBtn').textContent = '結束語音輸入';
        };

        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            output.value += transcript;
            analyzeText(); // 自動處理轉換後的文字
        };

        recognition.onend = function() {
            isRecording = false;
            document.getElementById('voiceBtn').classList.remove('recording');
            document.getElementById('voiceBtn').textContent = '開始語音輸入';
        };

        recognition.onerror = function(event) {
            console.error('語音識別錯誤:', event.error);
            let errorMessage = '語音識別錯誤，請重試。';
            switch(event.error) {
                case 'no-speech':
                    errorMessage = '未偵測到語音，請再試一次。';
                    break;
                case 'audio-capture':
                    errorMessage = '未能捕獲音頻，請檢查麥克風是否已啟用。';
                    break;
                case 'not-allowed':
                    errorMessage = '語音識別被阻止，請檢查瀏覽器權限設置。';
                    break;
            }
            alert(errorMessage);
        };

        document.getElementById('voiceBtn').onclick = function() {
            if (isRecording) {
                recognition.stop();
                return;
            }
            recognition.start();
        };
    }

    function clearText() {
        document.getElementById('inputTextArea').value = "";
        document.getElementById('orderTableBody').innerHTML = "";
        updateTotalPrice([]);
    }

    function completeOrder() {
        localStorage.setItem('orders', JSON.stringify(matchedInfo));
        alert("訂單已完成，資訊已保存。");
        clearText();
    }
</script>