<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>純數字計分板</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

    <style>
        body {
            margin: 0; padding: 0;
            background-color: #000; /* 純黑背景 */
            color: white;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            height: 100vh; width: 100vw;
            user-select: none; -webkit-user-select: none;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }

        /* 隱藏相機與畫布，但保留在 DOM 中以供 AI 讀取 */
        #hidden-layer {
            position: absolute; width: 1px; height: 1px;
            opacity: 0; pointer-events: none; overflow: hidden;
        }

        /* 分數顯示區 */
        #score-container {
            position: relative;
            z-index: 10;
            text-align: center;
        }

        #score {
            font-size: 35vh; /* 超大字體，佔視窗高度 35% */
            font-weight: bold;
            line-height: 1;
            font-feature-settings: "tnum"; /* 等寬數字，避免數字跳動 */
            transition: transform 0.1s;
        }

        /* 狀態指示燈 (因為看不到畫面，需要知道有沒有對準) */
        #status-dot {
            width: 20px; height: 20px;
            background-color: #F44336; /* 預設紅色：沒人 */
            border-radius: 50%;
            margin: 0 auto 20px auto;
            box-shadow: 0 0 10px rgba(255,255,255,0.2);
            transition: background-color 0.2s;
        }

        /* 進度條 (顯示舉手進度) */
        #progress-bar-container {
            width: 80vw;
            height: 10px;
            background: #333;
            border-radius: 5px;
            margin-top: 40px;
            overflow: hidden;
        }
        #progress-fill {
            height: 100%; width: 0%;
            background-color: #FFEB3B; /* 黃色進度 */
            transition: width 0.1s linear;
        }

        /* 文字提示 */
        #hint {
            color: #666; font-size: 1rem; margin-top: 10px;
        }

        /* 啟動按鈕 */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        #btn-go {
            padding: 20px 50px; font-size: 2rem;
            background: #fff; color: #000; border: none; border-radius: 100px;
            cursor: pointer; font-weight: bold;
        }

        /* 得分動畫 */
        .pop { transform: scale(1.2); color: #4CAF50 !important; }

        /* 全螢幕雙擊提示 (隱藏式) */
        #fs-hint {
            position: absolute; bottom: 20px; color: #333; font-size: 0.8rem;
        }
    </style>
</head>
<body>

    <div id="start-screen">
        <button id="btn-go" onclick="init()">START</button>
        <p style="color:#555; margin-top:20px;">相機將在背景運作</p>
    </div>

    <div id="hidden-layer">
        <video id="video" playsinline muted></video>
    </div>

    <div id="status-dot"></div> <div id="score-container">
        <div id="score">0</div>
    </div>

    <div id="progress-bar-container">
        <div id="progress-fill"></div>
    </div>
    
    <div id="hint">未偵測到人員</div>
    <div id="fs-hint">雙擊全螢幕</div>

    <script>
        let detector;
        let video;
        let score = 0;
        let holding = false;
        let holdStart = 0;
        const HOLD_TIME = 1500; // 1.5秒

        async function init() {
            const btn = document.getElementById('btn-go');
            btn.innerText = "準備中...";
            btn.disabled = true;

            try {
                // 1. 雖然不顯示，但仍需請求相機
                video = document.getElementById('video');
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: false,
                    video: { facingMode: 'user' }
                });
                video.srcObject = stream;
                await new Promise(r => video.onloadedmetadata = r);
                video.play();

                // 2. 載入極速版模型
                await tf.setBackend('webgl');
                detector = await poseDetection.createDetector(
                    poseDetection.SupportedModels.MoveNet, 
                    { modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING }
                );

                // 3. 進入介面
                document.getElementById('start-screen').style.display = 'none';
                loop();

            } catch (e) {
                alert("錯誤: " + e.message);
                btn.innerText = "重試"; btn.disabled = false;
            }
        }

        async function loop() {
            const poses = await detector.estimatePoses(video);
            
            // 邏輯處理
            if (poses.length > 0) {
                logic(poses[0]);
            } else {
                updateStatus(false, "未偵測到");
            }

            requestAnimationFrame(loop);
        }

        function logic(pose) {
            // 信心過低 = 沒人
            if (pose.score < 0.25) {
                updateStatus(false, "靠近一點");
                return;
            }

            const k = pose.keypoints;
            const nose = k.find(p => p.name === 'nose');
            
            // 如果連鼻子都找不到，視為沒對準
            if (!nose || nose.score < 0.3) {
                updateStatus(false, "請面對鏡頭");
                return;
            }

            // 找到了，亮綠燈
            updateStatus(true, "偵測中...");

            // 判斷舉手 (手腕 < 鼻子)
            const lW = k.find(p => p.name === 'left_wrist');
            const rW = k.find(p => p.name === 'right_wrist');
            
            let isUp = false;
            // 寬鬆判定：只要有一手信心高且舉起
            if ((lW && lW.score > 0.3 && lW.y < nose.y) || 
                (rW && rW.score > 0.3 && rW.y < nose.y)) {
                isUp = true;
            }

            const now = Date.now();
            if (isUp) {
                if (!holding) {
                    holding = true;
                    holdStart = now;
                } else {
                    // 計算進度
                    const elapsed = now - holdStart;
                    const pct = Math.min((elapsed / HOLD_TIME) * 100, 100);
                    
                    document.getElementById('progress-fill').style.width = pct + '%';
                    document.getElementById('hint').innerText = "堅持住!";

                    if (elapsed >= HOLD_TIME) {
                        addScore();
                        holding = false;
                        holdStart = now + 500; // 冷卻
                    }
                }
            } else {
                holding = false;
                document.getElementById('progress-fill').style.width = '0%';
                document.getElementById('hint').innerText = "請舉手得分";
            }
        }

        function addScore() {
            score++;
            const el = document.getElementById('score');
            el.innerText = score;
            el.classList.add('pop');
            
            // 震動
            if (navigator.vibrate) navigator.vibrate(200);

            setTimeout(() => el.classList.remove('pop'), 200);
            document.getElementById('progress-fill').style.width = '0%';
        }

        function updateStatus(isReady, msg) {
            const dot = document.getElementById('status-dot');
            const hint = document.getElementById('hint');
            
            hint.innerText = msg;
            
            if (isReady) {
                dot.style.backgroundColor = '#4CAF50'; // 綠燈
                dot.style.boxShadow = '0 0 15px #4CAF50';
            } else {
                dot.style.backgroundColor = '#F44336'; // 紅燈
                dot.style.boxShadow = 'none';
                // 沒人時歸零進度
                holding = false;
                document.getElementById('progress-fill').style.width = '0%';
            }
        }

        // 雙擊全螢幕
        document.addEventListener('dblclick', () => {
             if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
             else document.exitFullscreen();
        });
    </script>
</body>
</html>
