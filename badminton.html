<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>羽球自動計分</title>
    <style>
        /* 基礎設定：純黑省電 */
        body {
            margin: 0;
            height: 100vh;
            background-color: #000000;
            color: #444; /* 預設非發球方為暗灰 */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }

        /* 左右分割佈局 */
        .half {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            position: relative;
            transition: background-color 0.2s;
        }

        /* 左側邊框 */
        #area-left { border-right: 2px solid #222; }

        /* 分數顯示 */
        .score {
            font-size: 40vw;
            line-height: 1;
            font-weight: bold;
            transition: color 0.3s;
            pointer-events: none;
        }

        /* 發球方樣式 (高亮白色) */
        .serving .score {
            color: #ffffff;
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
        }

        /* 接球方樣式 (暗灰色) */
        .receiving .score {
            color: #333333;
        }

        /* 中央狀態燈 */
        #status-dot {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 12px;
            background-color: #222;
            border-radius: 50%;
            z-index: 10;
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        #status-dot.active {
            background-color: #00ff00;
            box-shadow: 0 0 15px #00ff00;
        }

        /* 底部提示 */
        #hint {
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
            font-size: 0.9rem;
            color: #333;
            pointer-events: none;
            transition: opacity 0.5s;
        }
    </style>
</head>
<body>

    <div id="status-dot"></div>

    <div class="half receiving" id="area-left">
        <div class="score" id="score-a">0</div>
    </div>

    <div class="half receiving" id="area-right">
        <div class="score" id="score-b">0</div>
    </div>

    <div id="hint">長按發球方開始 / 再次長按歸零</div>

    <script>
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = SpeechRecognition ? new SpeechRecognition() : null;

        if (recognition) {
            recognition.lang = 'cmn-Hant-TW'; // 台灣中文
            recognition.continuous = true;
            recognition.interimResults = false;
        }

        let scoreA = 0;
        let scoreB = 0;
        let server = null; // 'A', 'B', or null
        let isListening = false;
        let clickTimer = null;
        let longPressTimer = null;
        let longPressTriggered = false; // 避免長按後觸發點擊

        const areaA = document.getElementById('area-left');
        const areaB = document.getElementById('area-right');
        const elA = document.getElementById('score-a');
        const elB = document.getElementById('score-b');
        const statusDot = document.getElementById('status-dot');
        const hint = document.getElementById('hint');

        // --- 觸控邏輯 (長按開始/歸零) ---

        function handleTouchStart(team) {
            longPressTriggered = false;
            longPressTimer = setTimeout(() => {
                longPressTriggered = true;
                
                // 長按邏輯判斷
                if (server === null) {
                    // 1. 如果尚未開始 (server是null) -> 設定發球方並開始
                    startGame(team);
                } else {
                    // 2. 如果已經開始 -> 結束並歸零
                    resetGame();
                }
                
                // 震動回饋
                if (navigator.vibrate) navigator.vibrate(80);

            }, 800); // 長按 800ms 觸發
        }

        function handleTouchEnd() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }

        // 點擊事件 (用於暫停/繼續)
        function handleClick() {
            if (longPressTriggered) return; // 如果剛剛是長按，忽略這次點擊

            if (clickTimer) {
                clearTimeout(clickTimer);
                clickTimer = null;
                return; // 這是雙擊的一部分
            }

            clickTimer = setTimeout(() => {
                // 單擊邏輯：只有在遊戲進行中才允許手動暫停/繼續
                if (server !== null) {
                    toggleListening();
                } else {
                    flashHint("請先長按設定發球方");
                }
                clickTimer = null;
            }, 250);
        }

        // 綁定事件
        ['mousedown', 'touchstart'].forEach(evt => {
            areaA.addEventListener(evt, () => handleTouchStart('A'), {passive: true});
            areaB.addEventListener(evt, () => handleTouchStart('B'), {passive: true});
        });

        ['mouseup', 'touchend'].forEach(evt => {
            areaA.addEventListener(evt, handleTouchEnd);
            areaB.addEventListener(evt, handleTouchEnd);
        });

        // 全局點擊處理
        document.body.addEventListener('click', handleClick);

        // 雙擊全螢幕
        document.body.addEventListener('dblclick', () => {
            if (clickTimer) clearTimeout(clickTimer);
            toggleFullScreen();
        });


        // --- 遊戲邏輯 ---

        function startGame(team) {
            server = team;
            updateColors();
            startListening(); // 自動開始錄音
            flashHint((team === 'A' ? "左邊" : "右邊") + " 發球 - 監聽中");
        }

        function resetGame() {
            stopListening();
            scoreA = 0;
            scoreB = 0;
            server = null;
            elA.textContent = 0;
            elB.textContent = 0;
            updateColors();
            flashHint("已歸零");
        }

        function updateColors() {
            if (server === 'A') {
                areaA.className = 'half serving';
                areaB.className = 'half receiving';
            } else if (server === 'B') {
                areaA.className = 'half receiving';
                areaB.className = 'half serving';
            } else {
                areaA.className = 'half receiving';
                areaB.className = 'half receiving';
            }
        }

        function addScore(winner) {
            if (!server) return; // 沒開始前不計分

            if (winner === 'A') {
                scoreA++;
                elA.textContent = scoreA;
                highlight(elA, "#4ecdc4");
                if (server === 'B') server = 'A'; // 換發
            } else {
                scoreB++;
                elB.textContent = scoreB;
                highlight(elB, "#ff6b6b");
                if (server === 'A') server = 'B'; // 換發
            }
            updateColors();
        }

        function highlight(el, color) {
            el.style.textShadow = `0 0 40px ${color}`;
            setTimeout(() => el.style.textShadow = server === (el === elA ? 'A' : 'B') ? "0 0 10px rgba(255,255,255,0.3)" : "none", 400);
        }

        function flashHint(text) {
            hint.innerText = text;
            hint.style.opacity = 1;
            setTimeout(() => hint.style.opacity = 0, 2500);
        }

        // --- 語音控制 ---

        function startListening() {
            if (!recognition) return;
            try {
                recognition.start();
                isListening = true;
                statusDot.classList.add('active');
            } catch (e) {}
        }

        function stopListening() {
            if (!recognition) return;
            recognition.stop();
            isListening = false;
            statusDot.classList.remove('active');
        }

        function toggleListening() {
            if (isListening) {
                stopListening();
                flashHint("已暫停");
            } else {
                startListening();
                flashHint("繼續監聽");
            }
        }

        if (recognition) {
            recognition.onresult = (event) => {
                const text = event.results[event.results.length - 1][0].transcript;
                if (text.includes('左邊')) addScore('A');
                else if (text.includes('右邊')) addScore('B');
            };
            recognition.onend = () => { if (isListening) recognition.start(); };
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(()=>{});
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }
    </script>
</body>
</html>
