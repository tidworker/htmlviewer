<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大老二計分</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 10px;
            line-height: 1.6;
            background-color: #FFFFFF;
            color: #333;
        }
        h1 {
            text-align: center;
            font-size: 1.8em;
        }
        .player-buttons {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }
        button {
            padding: 10px;
            font-size: 1.2em;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            flex: 1;
            margin: 0 5px;
            background-color: #707070;
        }
        button:hover {
            opacity: 0.8;
        }
        .rules {
            margin: 20px 0;
            font-size: 1.2em;
            text-align: center;
        }
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 600px;
            background: #FFFFFF;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            display: none;
            z-index: 1000;
            color: #333;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 999;
        }
        .adjust-buttons {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
        }
        input[type="number"] {
            width: 100px;
            padding: 10px;
            font-size: 1.2em;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-top: 5px;
        }
        button.adjust {
            width: 60px;
            height: 60px;
            font-size: 1.2em;
            background-color: #707070;
            color: white;
            border-radius: 5px;
            border: none;
            cursor: pointer;
        }
        button.adjust:hover {
            background-color: #505050;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 25px;
            margin-top: 10px;
        }
        .switch input {
            display: none;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 15px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 19px;
            width: 19px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #707070;
        }
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        button.action {
            background-color: #707070;
            font-size: 1.2em;
            padding: 10px;
            border-radius: 5px;
            color: white;
            border: none;
            cursor: pointer;
        }
        button.action:hover {
            background-color: #505050;
        }
        label {
            font-weight: bold;
            display: block;
            margin-top: 15px;
        }
        .results {
            margin-top: 10px;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <h1>大老二計分</h1>

    <!-- 主頁面規則顯示 -->
    <div class="rules" id="rulesDisplay">
        規則：讀取中...
    </div>

    <div class="player-buttons">
        <button id="player1Btn">玩家 1</button>
        <button id="player2Btn">玩家 2</button>
        <button id="player3Btn">玩家 3</button>
        <button id="player4Btn">玩家 4</button>
    </div>

    <!-- 確認勝方模態窗 -->
    <div class="overlay" id="overlay"></div>
    <div class="modal" id="confirmWinnerModal">
        <p id="confirmWinnerText"></p>
        <button id="confirmWinnerBtn" class="action">確認</button>
        <button id="cancelWinnerBtn" class="action">取消</button>
    </div>

    <!-- 子頁面模態窗 -->
    <div class="modal" id="scoreModal">
        <h2 id="playerTitle"></h2>
        <label>張數 (1-13):</label>
        <div class="adjust-buttons">
            <button class="adjust decrease" data-type="cards">-</button>
            <input type="number" id="cardCount" value="1" min="1" max="13">
            <button class="adjust increase" data-type="cards">+</button>
        </div>
        <label>老二張數 (0-4):</label>
        <div class="adjust-buttons">
            <button class="adjust decrease" data-type="two">-</button>
            <input type="number" id="twoCount" value="0" min="0" max="4">
            <button class="adjust increase" data-type="two">+</button>
        </div>
        <label>怪物加成：</label>
        <label class="switch">
            <input type="checkbox" id="monsterBonusSwitch" onchange="updateScore()">
            <span class="slider"></span>
        </label>
        <p id="scoreResult" class="results">分數為：0 分</p>
        <button id="confirmScore" class="action">確定</button>
    </div>

    <script>
        const defaultRules = {
            multiplier: 2,
            double7: true,
            double10: true,
            double13: false,
        };

        // 從 localStorage 獲取規則
        const rules = JSON.parse(localStorage.getItem('gameRules')) || defaultRules;

        // 更新主頁面規則顯示
        function updateRulesDisplay() {
            const rulesText = `規則：倍率 ${rules.multiplier} | Double ${rules.double7 ? "7張, " : ""}${rules.double10 ? "10張, " : ""}${rules.double13 ? "13張" : ""}`.replace(/,\s*$/, '');
            document.getElementById('rulesDisplay').innerText = rulesText;
        }
        updateRulesDisplay();

        let winner = '';
        let currentLoserIndex = 0;
        const losers = [];
        const scores = {};

        for (let i = 1; i <= 4; i++) {
            scores[`player${i}`] = 0;
        }

        document.querySelectorAll('.player-buttons button').forEach((button, index) => {
            button.addEventListener('click', () => {
                winner = index + 1;
                document.getElementById('confirmWinnerText').innerText = `確認勝方為：玩家 ${winner} 嗎？`;
                document.getElementById('confirmWinnerModal').style.display = 'block';
                document.getElementById('overlay').style.display = 'block';
            });
        });

        document.getElementById('confirmWinnerBtn').addEventListener('click', () => {
            losers.length = 0;
            for (let i = 1; i <= 4; i++) {
                if (i !== winner) losers.push(i);
            }
            currentLoserIndex = 0;
            document.getElementById('confirmWinnerModal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
            showModal(losers[currentLoserIndex]);
        });

        document.getElementById('cancelWinnerBtn').addEventListener('click', () => {
            document.getElementById('confirmWinnerModal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
            winner = '';
        });

        function showModal(playerIndex) {
            const modal = document.getElementById('scoreModal');
            document.getElementById('playerTitle').innerText = `玩家 ${playerIndex}`;
            document.getElementById('cardCount').value = 1;
            document.getElementById('twoCount').value = 0;
            updateScore();
            modal.style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('scoreModal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        document.querySelectorAll('.adjust').forEach(button => {
            button.addEventListener('click', e => {
                const type = e.target.dataset.type;
                const input = document.getElementById(type === 'cards' ? 'cardCount' : 'twoCount');
                let value = parseInt(input.value) || 0;
                value += e.target.classList.contains('increase') ? 1 : -1;
                const min = parseInt(input.getAttribute('min'));
                const max = parseInt(input.getAttribute('max'));
                input.value = Math.max(min, Math.min(max, value));
                updateScore();
            });
        });

        function updateScore() {
            const cardCount = parseInt(document.getElementById('cardCount').value);
            const twoCount = parseInt(document.getElementById('twoCount').value);
            const monsterBonus = document.getElementById('monsterBonusSwitch').checked ? 2 : 1;

            let score = cardCount * Math.pow(2, twoCount) * rules.multiplier;

            if (rules.double7 && cardCount >= 7) score *= 2;
            if (rules.double10 && cardCount >= 10) score *= 2;
            if (rules.double13 && cardCount >= 13) score *= 2;

            score *= monsterBonus; // 怪物加成即時運算

            document.getElementById('scoreResult').innerText = `分數為：${-Math.abs(score)} 分`;
        }

        document.getElementById('confirmScore').addEventListener('click', () => {
            const playerIndex = losers[currentLoserIndex];
            const cardCount = parseInt(document.getElementById('cardCount').value);
            const twoCount = parseInt(document.getElementById('twoCount').value);
            const monsterBonus = document.getElementById('monsterBonusSwitch').checked ? 2 : 1;

            let score = cardCount * Math.pow(2, twoCount) * rules.multiplier;

            if (rules.double7 && cardCount >= 7) score *= 2;
            if (rules.double10 && cardCount >= 10) score *= 2;
            if (rules.double13 && cardCount >= 13) score *= 2;

            score *= monsterBonus;

            scores[`player${playerIndex}`] = -Math.abs(score);

            closeModal();
            currentLoserIndex++;
            if (currentLoserIndex < losers.length) {
                showModal(losers[currentLoserIndex]);
            } else {
                calculateWinnerScore();
            }
        });

        function calculateWinnerScore() {
            let totalNegative = 0;
            for (let i = 1; i <= 4; i++) {
                if (i !== winner) totalNegative += scores[`player${i}`];
            }
            scores[`player${winner}`] = Math.abs(totalNegative);

            // 顯示最終分數
            let resultText = '最終分數：\n';
            for (let i = 1; i <= 4; i++) {
                resultText += `玩家 ${i}：${scores[`player${i}`]} 分\n`;
            }
            alert(resultText);
        }
    </script>
</body>
</html>