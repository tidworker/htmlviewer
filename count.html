<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 10px;
            line-height: 1.6;
            background-color: #FFFFFF;
            color: #333;
        }
        h1 {
            text-align: center;
            font-size: 1.8em;
        }
        .rules {
            margin: 20px 0;
            font-size: 1.2em;
            text-align: center;
        }
        /* 玩家按鈕直列顯示 */
        .player-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
        }
        .player-buttons button {
            margin: 5px 0;
            width: 200px;
            padding: 10px;
            font-size: 1.2em;
            color: white;
            background-color: #707070;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .player-buttons button:hover {
            opacity: 0.8;
        }
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 600px;
            background: #FFFFFF;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            display: none;
            z-index: 1000;
            color: #333;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 999;
        }
        .adjust-buttons {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
        }
        input[type="number"] {
            width: 100px;
            padding: 10px;
            font-size: 1.2em;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-top: 5px;
        }
        button.adjust {
            width: 60px;
            height: 60px;
            font-size: 1.2em;
            background-color: #707070;
            color: white;
            border-radius: 5px;
            border: none;
            cursor: pointer;
        }
        button.adjust:hover {
            background-color: #505050;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 25px;
            margin-top: 10px;
        }
        .switch input {
            display: none;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 15px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 19px;
            width: 19px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #707070;
        }
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        button.action {
            background-color: #707070;
            font-size: 1.2em;
            padding: 10px;
            border-radius: 5px;
            color: white;
            border: none;
            cursor: pointer;
        }
        button.action:hover {
            background-color: #505050;
        }
        label {
            font-weight: bold;
            display: block;
            margin-top: 15px;
        }
        .results {
            margin-top: 10px;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <br>
    <br>
    <br>

    <div class="rules" id="rulesDisplay">規則：請至設定頁面設定...</div>

    <div class="player-buttons">
        <button id="player1Btn">玩家 1</button>
        <button id="player2Btn">玩家 2</button>
        <button id="player3Btn">玩家 3</button>
        <button id="player4Btn">玩家 4</button>
    </div>

 <h1>點選贏家開始計分</h1>

    <div class="overlay" id="overlay"></div>
    <div class="modal" id="confirmWinnerModal">
        <p id="confirmWinnerText"></p>
        <button id="confirmWinnerBtn" class="action">確認</button>
        <button id="cancelWinnerBtn" class="action">取消</button>
    </div>

    <div class="modal" id="scoreModal">
        <h2 id="playerTitle"></h2>
        <label>張數 (1-13):</label>
        <div class="adjust-buttons">
            <button class="adjust decrease" data-type="cards">-</button>
            <input type="number" id="cardCount" value="1" min="1" max="13">
            <button class="adjust increase" data-type="cards">+</button>
        </div>
        <label>老二張數 (0-4):</label>
        <div class="adjust-buttons">
            <button class="adjust decrease" data-type="two">-</button>
            <input type="number" id="twoCount" value="0" min="0" max="4">
            <button class="adjust increase" data-type="two">+</button>
        </div>
        <label>怪物加成：</label>
        <label class="switch">
            <input type="checkbox" id="monsterBonusSwitch" onchange="updateScore()">
            <span class="slider"></span>
        </label>
        <p id="scoreResult" class="results">分數為：0 分</p>
        <button id="confirmScore" class="action">確定</button>
    </div>

    <script>
        const players       = JSON.parse(localStorage.getItem('players'));
        const settings      = JSON.parse(localStorage.getItem('settings'));
        const scoresHistory = JSON.parse(localStorage.getItem('scoresHistory')) || [];

        if (!players || !settings) {
            alert('無法讀取設定資料，請先至設定頁面設置遊戲規則！');
            throw new Error('無法讀取設定資料');
        }

        function updateRulesDisplay() {
            const rules = settings.rules;
            const rulesText = `規則：倍率 ${settings.multiplier} | Double ${
                rules.rule7 ? '7張, ' : ''
            }${rules.rule10 ? '10張, ' : ''}${rules.rule13 ? '13張' : ''}`.replace(/,\s*$/, '');
            document.getElementById('rulesDisplay').innerText = rulesText;
        }
        updateRulesDisplay();

        document.getElementById('player1Btn').innerText = players.player1 || '玩家 1';
        document.getElementById('player2Btn').innerText = players.player2 || '玩家 2';
        document.getElementById('player3Btn').innerText = players.player3 || '玩家 3';
        document.getElementById('player4Btn').innerText = players.player4 || '玩家 4';

        let winner = '';
        let currentLoserIndex = 0;
        const losers = [];
        const scores = {};
        for (let i = 1; i <= 4; i++) {
            scores[`player${i}`] = 0;
        }

        document.querySelectorAll('.player-buttons button').forEach((btn, index) => {
            btn.addEventListener('click', () => {
                winner = index + 1;
                document.getElementById('confirmWinnerText').innerText =
                  `確認勝方為：${players[`player${winner}`]} 嗎？`;
                document.getElementById('confirmWinnerModal').style.display = 'block';
                document.getElementById('overlay').style.display = 'block';
            });
        });

        document.getElementById('confirmWinnerBtn').addEventListener('click', () => {
            losers.length = 0;
            for (let i = 1; i <= 4; i++) {
                if (i !== winner) {
                    losers.push(i);
                }
            }
            currentLoserIndex = 0;

            document.getElementById('confirmWinnerModal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';

            showModal(losers[currentLoserIndex]);
        });

        document.getElementById('cancelWinnerBtn').addEventListener('click', () => {
            document.getElementById('confirmWinnerModal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
            winner = '';
        });

        function showModal(playerIndex) {
            const modal = document.getElementById('scoreModal');
            document.getElementById('playerTitle').innerText =
              `玩家 ${players[`player${playerIndex}`]}`;
            document.getElementById('cardCount').value = 1;
            document.getElementById('twoCount').value  = 0;
            updateScore();
            modal.style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('scoreModal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        document.querySelectorAll('.adjust').forEach(button => {
            button.addEventListener('click', e => {
                const type = e.target.dataset.type;
                const input = document.getElementById(type === 'cards' ? 'cardCount' : 'twoCount');
                let value = parseInt(input.value) || 0;
                value += e.target.classList.contains('increase') ? 1 : -1;
                const min = parseInt(input.getAttribute('min'));
                const max = parseInt(input.getAttribute('max'));
                input.value = Math.max(min, Math.min(max, value));
                updateScore();
            });
        });

        function updateScore() {
            const cardCount = parseInt(document.getElementById('cardCount').value);
            const twoCount  = parseInt(document.getElementById('twoCount').value);
            const monsterBonus = document.getElementById('monsterBonusSwitch').checked ? 2 : 1;

            let score = cardCount * Math.pow(2, twoCount) * settings.multiplier;

            if (settings.rules.rule7 && cardCount >= 7) score *= 2;
            if (settings.rules.rule10 && cardCount >= 10) score *= 2;
            if (settings.rules.rule13 && cardCount >= 13) score *= 2;

            score *= monsterBonus;

            document.getElementById('scoreResult').innerText = `分數為：${-Math.abs(score)} 分`;
        }

        document.getElementById('confirmScore').addEventListener('click', () => {
            const playerIndex = losers[currentLoserIndex];
            const cardCount   = parseInt(document.getElementById('cardCount').value);
            const twoCount    = parseInt(document.getElementById('twoCount').value);
            const monsterBonus = document.getElementById('monsterBonusSwitch').checked ? 2 : 1;

            let score = cardCount * Math.pow(2, twoCount) * settings.multiplier;
            if (settings.rules.rule7 && cardCount >= 7) score *= 2;
            if (settings.rules.rule10 && cardCount >= 10) score *= 2;
            if (settings.rules.rule13 && cardCount >= 13) score *= 2;
            score *= monsterBonus;

            scores[`player${playerIndex}`] = -Math.abs(score);

            closeModal();

            // 完成本玩家計分後，再次詢問是否繼續下位玩家
            if (!confirm(`已為「${players[`player${playerIndex}`]}」計分：${scores[`player${playerIndex}`]}分。\n按「確定」進行下一位玩家，\n「取消」可回到本玩家重填分數。`)) {
                // 回到當前玩家
                showModal(playerIndex);
                return;
            }

            // 下一位玩家
            currentLoserIndex++;
            if (currentLoserIndex < losers.length) {
                showModal(losers[currentLoserIndex]);
            } else {
                // 所有玩家計算完成 -> 最終確認
                finalConfirm();
            }
        });

        function finalConfirm() {
            let totalNegative = 0;
            for (let i = 1; i <= 4; i++) {
                if (i !== winner) totalNegative += scores[`player${i}`];
            }
            scores[`player${winner}`] = Math.abs(totalNegative);

            let resultText = '最終分數：\n';
            for (let i = 1; i <= 4; i++) {
                resultText += `${players[`player${i}`]}：${scores[`player${i}`]} 分\n`;
            }

            if (confirm(`${resultText}\n確定記錄本回合分數？\n按「取消」則不紀錄`)) {
                // 確定 -> 寫入 localStorage
                const roundResult = {
                    round: scoresHistory.length + 1,
                    scores: { ...scores },
                    winner: players[`player${winner}`]
                };
                scoresHistory.push(roundResult);
                localStorage.setItem('scoresHistory', JSON.stringify(scoresHistory));
                alert('分數已記錄，將前往成績頁！');

                // === 新增：計算完成 -> 轉到 score.html ===
                // 若此頁不是在 iframe，可用 window.location.href
                // 若在 big2test.html 之 iframe 中，需要 parent or top
                // 依您檔案結構而定，這裡示範最簡單的：
                window.location.href = 'score.html';
            } else {
                // 不紀錄
                alert('本回合分數未記錄。');
            }
        }
    </script>
</body>
</html>