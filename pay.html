<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>持續 DTMF 聲音辨識程式</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 50px;
            background-color: #f0f0f0;
        }
        h1 {
            color: #333;
        }
        #controls {
            margin-top: 30px;
        }
        #startButton, #stopButton, #clearButton {
            padding: 15px 30px;
            font-size: 18px;
            cursor: pointer;
            margin: 10px;
            border: none;
            border-radius: 5px;
            color: white;
            transition: background-color 0.2s;
        }
        #startButton {
            background-color: #4CAF50;
        }
        #startButton:hover {
            background-color: #45a049;
        }
        #stopButton {
            background-color: #f44336;
        }
        #stopButton:hover {
            background-color: #da190b;
        }
        #clearButton {
            background-color: #555555;
        }
        #clearButton:hover {
            background-color: #333333;
        }
        #resultContainer {
            margin-top: 40px;
            text-align: left;
            display: inline-block;
            max-width: 600px;
            width: 100%;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        #resultContainer h2 {
            margin-top: 0;
            color: #333;
        }
        #result {
            font-size: 24px;
            color: #007BFF;
            word-wrap: break-word;
            min-height: 50px;
        }
        #status {
            margin-top: 20px;
            font-size: 18px;
            color: #555;
        }
    </style>
</head>
<body>
    <h1>持續 DTMF 聲音辨識程式</h1>
    <div id="controls">
        <button id="startButton">開始辨識</button>
        <button id="stopButton" disabled>停止辨識</button>
        <button id="clearButton">清除結果</button>
    </div>
    <div id="resultContainer">
        <h2>辨識結果:</h2>
        <div id="result">尚未辨識</div>
    </div>
    <div id="status">狀態: 未開始</div>

    <script>
        // DTMF 頻率表
        const DTMF_FREQS = {
            '1': [697, 1209],
            '2': [697, 1336],
            '3': [697, 1477],
            'A': [697, 1633],
            '4': [770, 1209],
            '5': [770, 1336],
            '6': [770, 1477],
            'B': [770, 1633],
            '7': [852, 1209],
            '8': [852, 1336],
            '9': [852, 1477],
            'C': [852, 1633],
            '*': [941, 1209],
            '0': [941, 1336],
            '#': [941, 1477],
            'D': [941, 1633]
        };

        const LOW_FREQS = [697, 770, 852, 941];
        const HIGH_FREQS = [1209, 1336, 1477, 1633];
        const TOLERANCE = 20; // 誤差範圍（Hz）
        const MIN_MAGNITUDE = -50; // 最小幅度閾值（分貝）

        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const clearButton = document.getElementById('clearButton');
        const resultDiv = document.getElementById('result');
        const statusDiv = document.getElementById('status');

        let audioContext;
        let analyser;
        let microphone;
        let dataArray;
        let isRunning = false;
        let lastDetected = null;
        let detectionCooldown = false;

        // 反向查找 DTMF 符號
        function findDTMF(low, high) {
            for (const [key, freqs] of Object.entries(DTMF_FREQS)) {
                const [lowFreq, highFreq] = freqs;
                if (Math.abs(low - lowFreq) <= TOLERANCE && Math.abs(high - highFreq) <= TOLERANCE) {
                    return key;
                }
            }
            return null;
        }

        // 計算頻譜峰值
        function getPeaks(frequencyData, sampleRate, fftSize) {
            const magnitudes = [];
            const freqs = [];
            for (let i = 0; i < frequencyData.length; i++) {
                const magnitude = frequencyData[i];
                if (magnitude > MIN_MAGNITUDE) { // 設定幅度閾值
                    const freq = i * sampleRate / fftSize;
                    freqs.push(freq);
                    magnitudes.push(magnitude);
                }
            }

            let max1 = { freq: 0, mag: 0 };
            let max2 = { freq: 0, mag: 0 };

            for (let i = 0; i < freqs.length; i++) {
                if (magnitudes[i] > max1.mag) {
                    max2 = max1;
                    max1 = { freq: freqs[i], mag: magnitudes[i] };
                } else if (magnitudes[i] > max2.mag) {
                    max2 = { freq: freqs[i], mag: magnitudes[i] };
                }
            }

            return [max1.freq, max2.freq];
        }

        // 初始化音訊
        async function initAudio() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048;
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            microphone = audioContext.createMediaStreamSource(stream);
            microphone.connect(analyser);
            dataArray = new Float32Array(analyser.fftSize);
        }

        // 開始辨識
        async function startRecognition() {
            if (isRunning) return;
            isRunning = true;
            startButton.disabled = true;
            stopButton.disabled = false;
            clearButton.disabled = true;
            statusDiv.textContent = '狀態: 正在辨識...';

            await initAudio();
            detectDTMF();
        }

        // 停止辨識
        function stopRecognition() {
            if (!isRunning) return;
            isRunning = false;
            startButton.disabled = false;
            stopButton.disabled = true;
            clearButton.disabled = false;
            statusDiv.textContent = '狀態: 停止辨識';

            if (microphone) {
                microphone.disconnect();
            }
            if (analyser) {
                analyser.disconnect();
            }
            if (audioContext) {
                audioContext.close();
            }
        }

        // DTMF 辨識主函數
        function detectDTMF() {
            if (!isRunning) return;

            analyser.getFloatFrequencyData(dataArray);
            const sampleRate = audioContext.sampleRate;
            const fftSize = analyser.fftSize;

            const peaks = getPeaks(dataArray, sampleRate, fftSize);
            if (peaks.length >= 2) {
                const lowFreq = Math.min(...peaks);
                const highFreq = Math.max(...peaks);
                const dtmf = findDTMF(lowFreq, highFreq);
                if (dtmf) {
                    // 防止重複偵測相同按鍵
                    if (dtmf !== lastDetected && !detectionCooldown) {
                        lastDetected = dtmf;
                        appendResult(dtmf);
                        // 如果偵測到 '#', 停止辨識
                        if (dtmf === '#') {
                            stopRecognition();
                            appendResult('(結束)');
                        } else {
                            // 設定冷卻時間，避免重複偵測
                            detectionCooldown = true;
                            setTimeout(() => {
                                detectionCooldown = false;
                            }, 1000); // 1秒冷卻
                        }
                    }
                }
            }

            requestAnimationFrame(detectDTMF);
        }

        // 顯示辨識結果
        function appendResult(dtmf) {
            if (resultDiv.textContent === '尚未辨識') {
                resultDiv.textContent = dtmf;
            } else {
                resultDiv.textContent += dtmf;
            }
        }

        // 清除結果
        function clearResult() {
            resultDiv.textContent = '尚未辨識';
            lastDetected = null;
        }

        // 按鈕事件
        startButton.addEventListener('click', startRecognition);
        stopButton.addEventListener('click', stopRecognition);
        clearButton.addEventListener('click', clearResult);

        // 提示使用 HTTPS
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            alert('為了使用麥克風，請透過 HTTPS 協議訪問此頁面。');
        }
    </script>
</body>
</html>