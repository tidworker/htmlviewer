<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>DTMF 聲音辨識程式</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 50px;
            background-color: #f0f0f0;
        }
        #startButton {
            padding: 15px 30px;
            font-size: 18px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
        }
        #startButton:hover {
            background-color: #45a049;
        }
        #result {
            margin-top: 30px;
            font-size: 32px;
            color: #333;
        }
        #instructions {
            margin-top: 20px;
            font-size: 16px;
            color: #555;
        }
    </style>
</head>
<body>
    <h1>DTMF 聲音辨識程式</h1>
    <button id="startButton">開始辨識</button>
    <div id="result">尚未辨識</div>
    <div id="instructions">
        <p>請按下按鈕並發出 DTMF 音（如電話鍵盤上的數字）以進行辨識。</p>
    </div>

    <script>
        // DTMF 頻率表
        const DTMF_FREQS = {
            '1': [697, 1209],
            '2': [697, 1336],
            '3': [697, 1477],
            'A': [697, 1633],
            '4': [770, 1209],
            '5': [770, 1336],
            '6': [770, 1477],
            'B': [770, 1633],
            '7': [852, 1209],
            '8': [852, 1336],
            '9': [852, 1477],
            'C': [852, 1633],
            '*': [941, 1209],
            '0': [941, 1336],
            '#': [941, 1477],
            'D': [941, 1633]
        };

        const LOW_FREQS = [697, 770, 852, 941];
        const HIGH_FREQS = [1209, 1336, 1477, 1633];

        const tolerance = 20; // 誤差範圍（Hz）

        const startButton = document.getElementById('startButton');
        const resultDiv = document.getElementById('result');

        let audioContext;
        let microphone;
        let scriptNode;
        let isRunning = false;

        // Goertzel 演算法實作
        class Goertzel {
            constructor(sampleRate, targetFreq, bufferSize) {
                this.sampleRate = sampleRate;
                this.targetFreq = targetFreq;
                this.bufferSize = bufferSize;
                this.k = Math.round(0.5 + ((bufferSize * targetFreq) / sampleRate));
                this.omega = (2.0 * Math.PI * this.k) / bufferSize;
                this.coeff = 2.0 * Math.cos(this.omega);
                this.reset();
            }

            reset() {
                this.s_prev = 0;
                this.s_prev2 = 0;
            }

            process(sample) {
                const s = sample + this.coeff * this.s_prev - this.s_prev2;
                this.s_prev2 = this.s_prev;
                this.s_prev = s;
            }

            get magnitude() {
                return Math.sqrt(this.s_prev2 * this.s_prev2 + this.s_prev * this.s_prev - this.coeff * this.s_prev * this.s_prev2);
            }
        }

        async function initAudio() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            microphone = audioContext.createMediaStreamSource(stream);
            scriptNode = audioContext.createScriptProcessor(4096, 1, 1);
            microphone.connect(scriptNode);
            scriptNode.connect(audioContext.destination);
        }

        function startRecognition() {
            if (isRunning) return;
            isRunning = true;
            startButton.textContent = '停止辨識';
            resultDiv.textContent = '正在辨識...';

            initAudio().then(() => {
                const bufferSize = 2048;
                const sampleRate = audioContext.sampleRate;

                // 初始化 Goertzel 演算法
                const goertzelLow = LOW_FREQS.map(freq => new Goertzel(sampleRate, freq, bufferSize));
                const goertzelHigh = HIGH_FREQS.map(freq => new Goertzel(sampleRate, freq, bufferSize));

                let buffer = [];

                scriptNode.onaudioprocess = function(audioProcessingEvent) {
                    const inputBuffer = audioProcessingEvent.inputBuffer;
                    const inputData = inputBuffer.getChannelData(0);

                    for (let i = 0; i < inputData.length; i++) {
                        buffer.push(inputData[i]);
                        if (buffer.length === bufferSize) {
                            // 將 buffer 資料傳遞給 Goertzel
                            goertzelLow.forEach(goertzel => goertzel.process(buffer[i]));
                            goertzelHigh.forEach(goertzel => goertzel.process(buffer[i]));

                            buffer = [];

                            // 計算幅度
                            const lowMagnitudes = goertzelLow.map(g => g.magnitude);
                            const highMagnitudes = goertzelHigh.map(g => g.magnitude);

                            // 找出最大幅度的低頻和高頻
                            const maxLow = Math.max(...lowMagnitudes);
                            const maxHigh = Math.max(...highMagnitudes);
                            const lowIndex = lowMagnitudes.indexOf(maxLow);
                            const highIndex = highMagnitudes.indexOf(maxHigh);

                            const detectedLow = LOW_FREQS[lowIndex];
                            const detectedHigh = HIGH_FREQS[highIndex];

                            // 檢查是否在容許範圍內
                            const matchedKey = findDTMF(detectedLow, detectedHigh);
                            if (matchedKey) {
                                resultDiv.textContent = `辨識結果: ${matchedKey}`;
                                stopRecognition();
                            }

                            // 重置 Goertzel
                            goertzelLow.forEach(g => g.reset());
                            goertzelHigh.forEach(g => g.reset());
                        }
                    }
                };
            }).catch(err => {
                console.error('無法存取麥克風:', err);
                resultDiv.textContent = '無法存取麥克風。請確認權限。';
                isRunning = false;
                startButton.textContent = '開始辨識';
            });
        }

        function stopRecognition() {
            if (!isRunning) return;
            isRunning = false;
            startButton.textContent = '開始辨識';
            resultDiv.textContent = '辨識已停止';

            if (scriptNode) {
                scriptNode.disconnect();
                scriptNode.onaudioprocess = null;
            }
            if (microphone) {
                microphone.disconnect();
            }
            if (audioContext) {
                audioContext.close();
            }
        }

        function findDTMF(low, high) {
            for (const [key, freqs] of Object.entries(DTMF_FREQS)) {
                const [lowFreq, highFreq] = freqs;
                if (Math.abs(low - lowFreq) <= tolerance && Math.abs(high - highFreq) <= tolerance) {
                    return key;
                }
            }
            return null;
        }

        // 按鈕事件
        startButton.addEventListener('click', () => {
            if (isRunning) {
                stopRecognition();
            } else {
                startRecognition();
            }
        });
    </script>
</body>
</html>